<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¯æœ¯é—¯å…³ - ä½œç­”ç«¯</title>
    <!-- å¾®ä¿¡åˆ†äº«é€‚é…å…ƒæ•°æ® -->
    <meta property="og:title" content="è¯æœ¯é—¯å…³ä½œç­”ç³»ç»Ÿ" />
    <meta property="og:description" content="3å…³è¯æœ¯å½•éŸ³ä»»åŠ¡ï¼Œå®Œæˆåå®æ—¶åŒæ­¥è‡³ç®¡ç†å¹³å°ï¼Œç­‰å¾…AIè¯„åˆ†" />
    <meta property="og:image" content="https://picsum.photos/300/200" /> <!-- åˆ†äº«ç¼©ç•¥å›¾ï¼ˆå¯æ›¿æ¢ä¸ºè‡ªå®šä¹‰å›¾ç‰‡ï¼‰ -->
    <meta property="og:type" content="website" />
    <meta name="description" content="è¯æœ¯é—¯å…³ç­”é¢˜ï¼Œæ”¯æŒå½•éŸ³è½¬MP3ï¼Œå®æ—¶åŒæ­¥ç®¡ç†å¹³å°">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- lamejsï¼šMP3ç¼–ç æ ¸å¿ƒä¾èµ–ï¼ˆå…¼å®¹ä¸»æµç§»åŠ¨ç«¯æµè§ˆå™¨ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        success: '#16a34a',
                        danger: '#dc2626',
                        neutral: '#64748b',
                        light: '#f8fafc'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .btn-primary {
                @apply bg-primary text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors;
            }
            .btn-danger {
                @apply bg-danger text-white py-2 px-6 rounded-lg hover:bg-red-700 transition-colors;
            }
            .btn-success {
                @apply bg-success text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors;
            }
            .btn-outline {
                @apply border border-primary text-primary py-2 px-6 rounded-lg hover:bg-primary hover:text-white transition-colors;
            }
            .audio-wave {
                @apply flex items-center justify-center gap-1 h-12 my-4;
            }
            .audio-wave-bar {
                @apply w-1 bg-primary rounded-full animate-wave h-1/2;
            }
            @keyframes wave {
                0%, 100% { transform: scaleY(0.5); }
                50% { transform: scaleY(1); }
            }
            .animate-wave { animation: wave 1.5s infinite; }
            .timer-warning { @apply text-orange-500 animate-pulse; }
            .timer-expired { @apply text-danger animate-pulse; }
            .module-hidden { @apply hidden; }
            .card { @apply bg-white rounded-xl shadow-md p-6 max-w-2xl mx-auto; }
            /* å¾®ä¿¡å¼•å¯¼å±‚æ ·å¼ */
            .wechat-guide {
                @apply fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center text-white p-4;
            }
        }
    </style>
</head>
<body class="bg-light min-h-screen py-8 font-sans">
    <!-- å¾®ä¿¡æ‰“å¼€å¼•å¯¼å±‚ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼Œå¾®ä¿¡å†…æ˜¾ç¤ºï¼‰ -->
    <div id="wechatGuide" class="wechat-guide module-hidden">
        <<i class="fa fa-weixin text-5xl mb-4"></</i>
        <h3 class="text-xl font-bold mb-2">è¯·åœ¨å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€</h3>
        <p class="text-center mb-6">å¾®ä¿¡å†…å¯èƒ½é™åˆ¶å½•éŸ³æƒé™ï¼Œç‚¹å‡»å³ä¸Šè§’ <<i class="fa fa-ellipsis-v"></</i>ï¼Œé€‰æ‹©ã€Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ã€</p>
        <button id="closeGuideBtn" class="btn-primary">æˆ‘å·²åœ¨å¤–éƒ¨æµè§ˆå™¨æ‰“å¼€</button>
    </div>

    <!-- 1. å…¥å£æ¨¡å—ï¼ˆåˆå§‹æ˜¾ç¤ºï¼‰ -->
    <div id="entryModule" class="container mx-auto px-4">
        <div class="card">
            <div class="text-center mb-6">
                <<i class="fa fa-microphone text-primary text-4xl mb-3"></</i>
                <h1 class="text-2xl font-bold text-primary">è¯æœ¯é—¯å…³ä½œç­”ç³»ç»Ÿ</h1>
            </div>
            <!-- å”¯ä¸€æ ‡è¯†è¾“å…¥ -->
            <div class="mb-6">
                <label for="userUniqueId" class="block text-neutral mb-2 font-medium">å§“å/å·¥å·ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ï¼š</label>
                <input type="text" id="userUniqueId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ / 001" autocomplete="off">
                <p id="idErrorTip" class="text-danger text-sm mt-2 module-hidden"></p>
            </div>
            <!-- ä½œç­”é¡»çŸ¥ï¼ˆç®€æ´æ˜äº†ï¼‰ -->
            <div class="bg-blue-50 rounded-lg p-4 mb-6 text-left">
                <p class="text-primary text-sm font-medium mb-2">ğŸ“Œ ä½œç­”é¡»çŸ¥</p>
                <ul class="text-neutral text-sm list-disc list-inside space-y-1">
                    <li>æ¯äººä»…å¯ä½œç­”1æ¬¡ï¼Œæäº¤åæ— æ³•ä¿®æ”¹</li>
                    <li>å…±3å…³è¯æœ¯åœºæ™¯ï¼Œæ¯å…³é™æ—¶8åˆ†é’Ÿ</li>
                    <li>å½•éŸ³è‡ªåŠ¨è½¬MP3ï¼Œå®æ—¶åŒæ­¥ç®¡ç†å¹³å°</li>
                    <li>å®Œæˆåç­‰å¾…ç®¡ç†å‘˜AIè¯„åˆ†</li>
                </ul>
            </div>
            <!-- å¼€å§‹ä½œç­”æŒ‰é’® -->
            <button id="startAnswerBtn" class="btn-primary w-full">
                <<i class="fa fa-play-circle mr-2"></</i>è¿›å…¥ç­”é¢˜é¡µé¢
            </button>
        </div>
    </div>

    <!-- 2. ç­”é¢˜æ¨¡å—ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="answerModule" class="container mx-auto px-4 module-hidden">
        <h1 class="text-2xl font-bold text-center text-primary mb-8">è¯æœ¯é—¯å…³ - ç­”é¢˜é¡µé¢</h1>
        <!-- ç­”é¢˜è¿›åº¦ -->
        <div class="mb-6 max-w-2xl mx-auto">
            <div class="flex justify-between text-sm text-neutral mb-2">
                <span>å½“å‰å…³å¡</span>
                <span id="levelTip">ç¬¬ <span id="currentLevel">1</span>/3 å…³</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-primary rounded-full" style="width: 33.3%"></div>
            </div>
        </div>
        <!-- ç­”é¢˜è®¡æ—¶å™¨ -->
        <div class="text-center mb-6">
            <p class="text-neutral text-sm mb-2">å‰©ä½™ç­”é¢˜æ—¶é—´</p>
            <p id="timer" class="text-2xl font-bold">08:00</p>
        </div>
        <!-- å…³å¡åœºæ™¯ä¿¡æ¯ -->
        <div class="card mb-6">
            <h3 class="text-lg font-bold mb-3" id="levelTitle">ç¬¬1å…³ï¼šåˆæ¬¡æ¥è§¦ - äº§å“ä»‹ç»</h3>
            <div class="mb-4">
                <p class="text-sm text-neutral font-medium mb-1">åœºæ™¯æè¿°ï¼š</p>
                <p id="scenarioContent" class="text-neutral"></p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                <div class="bg-blue-50 rounded-lg p-3">
                    <p class="text-xs text-primary font-medium mb-1">æ ¸å¿ƒå…³é”®è¯ï¼ˆå¿…é¡»è¦†ç›–ï¼‰ï¼š</p>
                    <p id="coreKeywords" class="text-sm text-neutral"></p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-3">
                    <p class="text-xs text-yellow-600 font-medium mb-1">ç¦æ­¢è¡¨è¿°ï¼ˆæ•æ„Ÿè¯ï¼‰ï¼š</p>
                    <p id="sensitiveWords" class="text-sm text-neutral"></p>
                </div>
            </div>
        </div>
        <!-- å½•éŸ³åŒºåŸŸï¼ˆå…¼å®¹è·¨æµè§ˆå™¨ï¼‰ -->
        <div class="card mb-6">
            <h3 class="text-lg font-bold mb-3 flex items-center">
                <<i class="fa fa-microphone text-primary mr-2"></</i>å½•éŸ³æ“ä½œï¼ˆè‡ªåŠ¨ç”ŸæˆMP3ï¼‰
            </h3>
            <!-- éŸ³é¢‘æ³¢å½¢åŠ¨ç”» -->
            <div id="audioWave" class="audio-wave module-hidden">
                <div class="audio-wave-bar"></div>
                <div class="audio-wave-bar" style="animation-delay: 0.1s"></div>
                <div class="audio-wave-bar" style="animation-delay: 0.2s"></div>
                <div class="audio-wave-bar" style="animation-delay: 0.3s"></div>
                <div class="audio-wave-bar" style="animation-delay: 0.4s"></div>
                <div class="audio-wave-bar" style="animation-delay: 0.3s"></div>
                <div class="audio-wave-bar" style="animation-delay: 0.2s"></div>
                <div class="audio-wave-bar" style="animation-delay: 0.1s"></div>
                <div class="audio-wave-bar"></div>
            </div>
            <!-- å½•éŸ³æ§åˆ¶æŒ‰é’® -->
            <div class="flex gap-3 justify-center mb-4">
                <button id="startRecordBtn" class="btn-primary">
                    <<i class="fa fa-microphone mr-2"></</i>å¼€å§‹å½•éŸ³
                </button>
                <button id="stopRecordBtn" class="btn-danger module-hidden">
                    <<i class="fa fa-stop mr-2"></</i>åœæ­¢å½•éŸ³
                </button>
            </div>
            <!-- å…¼å®¹æ€§æç¤º -->
            <p class="text-xs text-neutral text-center mb-2">
                æç¤ºï¼šè‹¥æ— æ³•å½•éŸ³ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™æˆ–åˆ‡æ¢è‡³Chrome/Edgeæµè§ˆå™¨
            </p>
            <!-- MP3é¢„è§ˆåŒºåŸŸ -->
            <div id="mp3PreviewArea" class="module-hidden">
                <p class="text-sm text-success mb-2 text-center">âœ… å½•éŸ³å·²è½¬MP3ï¼Œå®æ—¶åŒæ­¥è‡³ç®¡ç†å¹³å°</p>
                <audio id="mp3Preview" controls class="w-full"></audio>
            </div>
        </div>
        <!-- ä¸‹ä¸€æ­¥/æäº¤æŒ‰é’® -->
        <div class="flex gap-3 justify-center max-w-2xl mx-auto">
            <button id="prevLevelBtn" class="btn-outline module-hidden">
                <<i class="fa fa-arrow-left mr-2"></</i>ä¸Šä¸€å…³
            </button>
            <button id="nextLevelBtn" class="btn-primary module-hidden">
                <<i class="fa fa-arrow-right mr-2"></</i>ä¸‹ä¸€å…³
            </button>
            <button id="submitAllBtn" class="btn-success module-hidden">
                <<i class="fa fa-paper-plane mr-2"></</i>æäº¤æ‰€æœ‰ç­”å·
            </button>
        </div>
    </div>

    <!-- 3. å®Œæˆæ¨¡å—ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="completeModule" class="container mx-auto px-4 module-hidden">
        <div class="card text-center">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h1 class="text-2xl font-bold text-primary mb-2">ä½œç­”å®Œæˆï¼</h1>
            <p class="text-neutral mb-4" id="completeUserTip">
                å°Šæ•¬çš„ã€xxxã€‘ï¼Œæ‚¨çš„æ‰€æœ‰å½•éŸ³å·²åŒæ­¥è‡³ç®¡ç†å¹³å°
            </p>
            <p class="text-sm text-neutral mb-6">
                è¯·ç­‰å¾…ç®¡ç†å‘˜è¿›è¡ŒAIè¯„åˆ†ï¼Œç»“æœå°†ç»Ÿä¸€åé¦ˆ
            </p>
            <div class="bg-blue-50 rounded-lg p-4 mb-6 text-left">
                <p class="text-xs text-primary font-medium mb-2">ğŸ“Œ åç»­è¯´æ˜</p>
                <ul class="text-xs text-neutral list-disc list-inside space-y-1">
                    <li>ä»…1æ¬¡ä½œç­”æœºä¼šï¼Œæ— æ³•é‡æ–°ç­”é¢˜</li>
                    <li>MP3æ–‡ä»¶å·²æ°¸ä¹…ä¿å­˜è‡³ç®¡ç†å¹³å°</li>
                    <li>ç–‘é—®è¯·è”ç³»ç®¡ç†å‘˜è·å–è¯¦æƒ…</li>
                </ul>
            </div>
            <button id="backEntryBtn" class="btn-primary w-full">
                <<i class="fa fa-home mr-2"></</i>è¿”å›å…¥å£é¡µé¢
            </button>
        </div>
    </div>

    <script>
        // å…¨å±€é…ç½®
        const levelDataList = [
            {
                levelId: 1,
                levelTitle: 'åˆæ¬¡æ¥è§¦ - äº§å“ä»‹ç»',
                scenario: 'æ‚¨æ˜¯é”€å”®é¡¾é—®ï¼Œéœ€å‘æ–°å®¢æˆ·ä»‹ç»å…¬å¸æ ¸å¿ƒäº§å“ï¼ŒåŒ…å«äº§å“åç§°ã€3é¡¹æ ¸å¿ƒåŠŸèƒ½ã€2ä¸ªç«äº‰ä¼˜åŠ¿ï¼Œéœ€æœ‰å®Œæ•´å¼€åœºç™½å’Œç»“æŸè¯­',
                coreKeywords: ['äº§å“åç§°', 'æ ¸å¿ƒåŠŸèƒ½', 'ç«äº‰ä¼˜åŠ¿', 'å¼€åœºç™½', 'ç»“æŸè¯­'],
                complianceSteps: ['å¼€åœºç™½', 'äº§å“åç§°ä»‹ç»', 'æ ¸å¿ƒåŠŸèƒ½è®²è§£', 'ç«äº‰ä¼˜åŠ¿æç‚¼', 'ç»“æŸè¯­'],
                sensitiveWords: ['ç»å¯¹', 'ä¿è¯', 'æœ€å¥½', 'æ— æ•Œ', 'å”¯ä¸€'],
                coreTopic: 'å…¬å¸æ ¸å¿ƒäº§å“ä»‹ç»'
            },
            {
                levelId: 2,
                levelTitle: 'éœ€æ±‚æŒ–æ˜ - å®¢æˆ·æ²Ÿé€š',
                scenario: 'ä¸æ½œåœ¨å®¢æˆ·æ²Ÿé€šï¼ŒæŒ–æ˜çœŸå®éœ€æ±‚ï¼Œéœ€æå‡ºè‡³å°‘3ä¸ªå¼€æ”¾æ€§é—®é¢˜ï¼Œè¡¨è¾¾åŒç†å¿ƒï¼Œç¡®è®¤å®¢æˆ·ç—›ç‚¹',
                coreKeywords: ['æ½œåœ¨å®¢æˆ·', 'çœŸå®éœ€æ±‚', 'å¼€æ”¾æ€§é—®é¢˜', 'åŒç†å¿ƒ', 'å®¢æˆ·ç—›ç‚¹'],
                complianceSteps: ['ç ´å†°å¼€åœº', 'å¼€æ”¾æ€§æé—®', 'éœ€æ±‚ç¡®è®¤', 'åŒç†å¿ƒè¡¨è¾¾', 'åˆæ­¥å»ºè®®'],
                sensitiveWords: ['å¿…é¡»', 'å¼ºåˆ¶', 'åˆ«æ— é€‰æ‹©', 'ä¸ä¹°åæ‚”'],
                coreTopic: 'æ½œåœ¨å®¢æˆ·éœ€æ±‚æŒ–æ˜'
            },
            {
                levelId: 3,
                levelTitle: 'å¼‚è®®å¤„ç† - æŒ½å›å®¢æˆ·',
                scenario: 'å®¢æˆ·å¯¹ä»·æ ¼æå‡ºå¼‚è®®ï¼Œéœ€è¡¨è¾¾åŒç†å¿ƒï¼Œæä¾›æŠ˜ä¸­è§£å†³æ–¹æ¡ˆï¼Œå¼ºåŒ–äº§å“ä»·å€¼ï¼Œæ¶ˆé™¤å®¢æˆ·ç–‘è™‘',
                coreKeywords: ['ä»·æ ¼å¼‚è®®', 'åŒç†å¿ƒ', 'æŠ˜ä¸­æ–¹æ¡ˆ', 'äº§å“ä»·å€¼', 'ç–‘è™‘æ¶ˆé™¤'],
                complianceSteps: ['æƒ…ç»ªå®‰æŠš', 'åŒç†å¿ƒè¡¨è¾¾', 'è§£å†³æ–¹æ¡ˆæä¾›', 'ä»·å€¼å¼ºåŒ–', 'ç–‘è™‘æ¶ˆé™¤'],
                sensitiveWords: ['æœ€ä½ä»·æ ¼', 'é”™è¿‡å°±æ²¡', 'ç»å¯¹åˆ’ç®—', 'æ²¡æ³•ä¼˜æƒ '],
                coreTopic: 'å®¢æˆ·ä»·æ ¼å¼‚è®®å¤„ç†'
            }
        ];
        const fillerWordList = ["å‘ƒ", "å•Š", "å—¯", "å“¦", "å‘ƒå‘ƒ", "å•Šå•Š", "é‚£ä¸ª", "ç„¶åå‘¢", "å…¶å®å§", "è¯´ç™½äº†"];

        // å…¨å±€å˜é‡
        let userUniqueId = '';
        let userAnswerData = null;
        let currentLevelIndex = 0;
        let mediaRecorder = null;
        let audioChunks = [];
        let timerInterval = null;
        let remainingTime = 8 * 60;

        // DOMå…ƒç´ 
        const wechatGuide = document.getElementById('wechatGuide');
        const closeGuideBtn = document.getElementById('closeGuideBtn');
        const entryModule = document.getElementById('entryModule');
        const userUniqueIdInput = document.getElementById('userUniqueId');
        const idErrorTip = document.getElementById('idErrorTip');
        const startAnswerBtn = document.getElementById('startAnswerBtn');
        const answerModule = document.getElementById('answerModule');
        const currentLevel = document.getElementById('currentLevel');
        const progressBar = document.getElementById('progressBar');
        const timer = document.getElementById('timer');
        const levelTitle = document.getElementById('levelTitle');
        const scenarioContent = document.getElementById('scenarioContent');
        const coreKeywords = document.getElementById('coreKeywords');
        const sensitiveWords = document.getElementById('sensitiveWords');
        const audioWave = document.getElementById('audioWave');
        const startRecordBtn = document.getElementById('startRecordBtn');
        const stopRecordBtn = document.getElementById('stopRecordBtn');
        const mp3PreviewArea = document.getElementById('mp3PreviewArea');
        const mp3Preview = document.getElementById('mp3Preview');
        const prevLevelBtn = document.getElementById('prevLevelBtn');
        const nextLevelBtn = document.getElementById('nextLevelBtn');
        const submitAllBtn = document.getElementById('submitAllBtn');
        const completeModule = document.getElementById('completeModule');
        const completeUserTip = document.getElementById('completeUserTip');
        const backEntryBtn = document.getElementById('backEntryBtn');

        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // æ£€æµ‹å¾®ä¿¡æµè§ˆå™¨ï¼Œæ˜¾ç¤ºå¼•å¯¼å±‚
            if (isWechatBrowser()) {
                wechatGuide.classList.remove('module-hidden');
            }
            bindAllEvents();
            checkRepeatAnswer();
        });

        // æ ¸å¿ƒè¾…åŠ©å‡½æ•°
        // æ£€æµ‹æ˜¯å¦ä¸ºå¾®ä¿¡å†…ç½®æµè§ˆå™¨
        function isWechatBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.includes('micromessenger') && !ua.includes('windowswechat');
        }

        // ç»‘å®šæ‰€æœ‰äº‹ä»¶
        function bindAllEvents() {
            // å¾®ä¿¡å¼•å¯¼å±‚å…³é—­äº‹ä»¶
            closeGuideBtn.addEventListener('click', () => wechatGuide.classList.add('module-hidden'));
            // å…¥å£æ¨¡å—äº‹ä»¶
            startAnswerBtn.addEventListener('click', handleStartAnswer);
            userUniqueIdInput.addEventListener('input', () => {
                idErrorTip.classList.add('module-hidden');
                startAnswerBtn.disabled = false;
                startAnswerBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            // ç­”é¢˜æ¨¡å—äº‹ä»¶
            startRecordBtn.addEventListener('click', startRecording);
            stopRecordBtn.addEventListener('click', stopRecording);
            prevLevelBtn.addEventListener('click', goToPrevLevel);
            nextLevelBtn.addEventListener('click', goToNextLevel);
            submitAllBtn.addEventListener('click', submitAllAnswers);
            // å®Œæˆæ¨¡å—äº‹ä»¶
            backEntryBtn.addEventListener('click', goBackToEntry);
        }

        // æ£€æŸ¥é‡å¤ä½œç­”
        function checkRepeatAnswer() {
            const globalAnswerData = JSON.parse(localStorage.getItem('speakingGameAnswerData')) || {};
            userUniqueIdInput.addEventListener('blur', () => {
                const userId = userUniqueIdInput.value.trim();
                if (userId && globalAnswerData[userId] && globalAnswerData[userId].isCompleted) {
                    idErrorTip.textContent = 'æ‚¨å·²å®Œæˆä½œç­”ï¼Œæ— æ³•é‡å¤è¿›å…¥';
                    idErrorTip.classList.remove('module-hidden');
                    startAnswerBtn.disabled = true;
                    startAnswerBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·æ ‡è¯†
        function generateUserToken() {
            const timestamp = new Date().getTime().toString(16);
            const randomStr = Math.random().toString(16).slice(2, 8);
            return `answer_${timestamp}_${randomStr}`;
        }

        // å¤„ç†å¼€å§‹ä½œç­”
        function handleStartAnswer() {
            userUniqueId = userUniqueIdInput.value.trim();
            if (!userUniqueId) {
                idErrorTip.textContent = 'è¯·è¾“å…¥å§“å/å·¥å·ä½œä¸ºå”¯ä¸€æ ‡è¯†';
                idErrorTip.classList.remove('module-hidden');
                return;
            }

            const globalAnswerData = JSON.parse(localStorage.getItem('speakingGameAnswerData')) || {};
            if (globalAnswerData[userUniqueId] && globalAnswerData[userUniqueId].isCompleted) {
                idErrorTip.textContent = 'æ‚¨å·²å®Œæˆä½œç­”ï¼Œæ— æ³•é‡å¤è¿›å…¥';
                idErrorTip.classList.remove('module-hidden');
                return;
            }

            // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
            if (!globalAnswerData[userUniqueId]) {
                userAnswerData = {
                    userUniqueId: userUniqueId,
                    userToken: generateUserToken(),
                    isCompleted: false,
                    completeTime: '',
                    totalScore: null,
                    isScored: false,
                    currentLevel: 0,
                    levelData: levelDataList.map(level => ({
                        ...level,
                        audioMP3Base64: '',
                        audioUrl: '',
                        transcript: '',
                        audioFeatures: {
                            fillerWordCount: 0,
                            stutterCount: 0,
                            rawContent: ''
                        },
                        scoreDetail: {
                            keywordScore: null,
                            complianceScore: null,
                            fluencyScore: null,
                            logicScore: null,
                            levelTotal: null
                        }
                    }))
                };
                globalAnswerData[userUniqueId] = userAnswerData;
                localStorage.setItem('speakingGameAnswerData', JSON.stringify(globalAnswerData));
                window.dispatchEvent(new StorageEvent('storage', { key: 'speakingGameAnswerData' }));
            } else {
                userAnswerData = globalAnswerData[userUniqueId];
                currentLevelIndex = userAnswerData.currentLevel;
            }

            // åˆ‡æ¢æ¨¡å—
            entryModule.classList.add('module-hidden');
            answerModule.classList.remove('module-hidden');
            initCurrentLevel(currentLevelIndex);
        }

        // åˆå§‹åŒ–å½“å‰å…³å¡
        function initCurrentLevel(index) {
            const currentLevelData = userAnswerData.levelData[index];
            if (!currentLevelData) return;

            currentLevel.textContent = index + 1;
            progressBar.style.width = `${((index + 1) / userAnswerData.levelData.length) * 100}%`;
            levelTitle.textContent = `ç¬¬${index + 1}å…³ï¼š${currentLevelData.levelTitle}`;
            scenarioContent.textContent = currentLevelData.scenario;
            coreKeywords.textContent = currentLevelData.coreKeywords.join('ã€');
            sensitiveWords.textContent = currentLevelData.sensitiveWords.join('ã€');

            // æŒ‰é’®çŠ¶æ€æ§åˆ¶
            prevLevelBtn.classList.toggle('module-hidden', index === 0);
            nextLevelBtn.classList.toggle('module-hidden', index === userAnswerData.levelData.length - 1 || !currentLevelData.audioMP3Base64);
            submitAllBtn.classList.toggle('module-hidden', index !== userAnswerData.levelData.length - 1 || !currentLevelData.audioMP3Base64);

            // é‡ç½®å½•éŸ³å’Œè®¡æ—¶å™¨
            resetRecordUI();
            resetTimer();
            startTimer();

            // æ˜¾ç¤ºå·²æœ‰å½•éŸ³
            if (currentLevelData.audioMP3Base64) {
                mp3Preview.src = currentLevelData.audioUrl;
                mp3PreviewArea.classList.remove('module-hidden');
            }
        }

        // å½•éŸ³ç›¸å…³å‡½æ•°ï¼ˆå…¼å®¹è·¨æµè§ˆå™¨ï¼‰
        function resetRecordUI() {
            audioWave.classList.add('module-hidden');
            mp3PreviewArea.classList.add('module-hidden');
            mp3Preview.src = '';
            startRecordBtn.classList.remove('module-hidden');
            stopRecordBtn.classList.add('module-hidden');
            audioChunks = [];
            mediaRecorder = null;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            remainingTime = 8 * 60;
            updateTimerDisplay();
            timer.classList.remove('timer-warning', 'timer-expired');
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();
                if (remainingTime <= 60) timer.classList.add('timer-expired');
                else if (remainingTime <= 180) timer.classList.add('timer-warning');
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    alert('ç­”é¢˜æ—¶é—´å·²åˆ°ï¼');
                    if (userAnswerData.levelData[currentLevelIndex].audioMP3Base64) {
                        currentLevelIndex < userAnswerData.levelData.length - 1 ? goToNextLevel() : submitAllAnswers();
                    } else resetRecordUI();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60).toString().padStart(2, '0');
            const seconds = (remainingTime % 60).toString().padStart(2, '0');
            timer.textContent = `${minutes}:${seconds}`;
        }

        async function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chrome/Edge/ç™¾åº¦æµè§ˆå™¨');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' });
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.start();
                audioWave.classList.remove('module-hidden');
                startRecordBtn.classList.add('module-hidden');
                stopRecordBtn.classList.remove('module-hidden');
            } catch (err) {
                alert(`è·å–éº¦å…‹é£å¤±è´¥ï¼š${err.message}ï¼Œè¯·æˆäºˆéº¦å…‹é£æƒé™åé‡è¯•`);
                console.error('å½•éŸ³åˆå§‹åŒ–å¤±è´¥ï¼š', err);
            }
        }

        async function stopRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
            mediaRecorder.stop();
            mediaRecorder.onstop = async () => {
                try {
                    // WebMè½¬MP3
                    const webmBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const mp3Blob = await convertWebmToMp3(webmBlob);
                    const mp3Url = URL.createObjectURL(mp3Blob);
                    const mp3Base64 = await blobToBase64(mp3Blob);

                    // éŸ³é¢‘ç‰¹å¾æå–
                    const audioProcessResult = await processAudioFeatures(mp3Blob);

                    // åŒæ­¥æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¼€å‘è€…ç«¯å®æ—¶è¯»å–ï¼‰
                    await syncAudioData(mp3Url, mp3Base64, audioProcessResult);

                    // æ›´æ–°UI
                    mp3Preview.src = mp3Url;
                    mp3PreviewArea.classList.remove('module-hidden');
                    audioWave.classList.add('module-hidden');
                    stopRecordBtn.classList.add('module-hidden');
                    startRecordBtn.classList.remove('module-hidden');
                    currentLevelIndex < userAnswerData.levelData.length - 1 
                        ? nextLevelBtn.classList.remove('module-hidden') 
                        : submitAllBtn.classList.remove('module-hidden');

                    // åœæ­¢éº¦å…‹é£
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                } catch (err) {
                    console.error('å½•éŸ³å¤„ç†å¤±è´¥ï¼š', err);
                    alert('å½•éŸ³è½¬MP3å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
                }
            };
        }

        // MP3è½¬æ¢å’Œæ•°æ®åŒæ­¥ï¼ˆä¿æŒåŸé€»è¾‘ï¼Œå…¼å®¹è·¨æµè§ˆå™¨ï¼‰
        async function convertWebmToMp3(webmBlob) {
            return new Promise((resolve, reject) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const fileReader = new FileReader();
                fileReader.onload = (e) => {
                    audioContext.decodeAudioData(e.target.result, (audioBuffer) => {
                        const channelCount = audioBuffer.numberOfChannels;
                        const sampleRate = audioBuffer.sampleRate;
                        const mp3Encoder = new lamejs.Mp3Encoder(channelCount, sampleRate, 128);
                        const to16Bit = (floatArr) => {
                            const intArr = new Int16Array(floatArr.length);
                            for (let i = 0; i < floatArr.length; i++) {
                                intArr[i] = Math.min(1, Math.max(-1, floatArr[i])) * (floatArr[i] < 0 ? -32768 : 32767);
                            }
                            return intArr;
                        };
                        const left = to16Bit(audioBuffer.getChannelData(0));
                        const right = channelCount > 1 ? to16Bit(audioBuffer.getChannelData(1)) : left;
                        const mp3Data = [];
                        const chunkSize = 1024 * 5;
                        for (let i = 0; i < left.length; i += chunkSize) {
                            const leftChunk = left.subarray(i, i + chunkSize);
                            const rightChunk = right.subarray(i, i + chunkSize);
                            const chunk = channelCount === 1 ? mp3Encoder.encodeBuffer(leftChunk) : mp3Encoder.encodeBuffer(leftChunk, rightChunk);
                            if (chunk.length) mp3Data.push(chunk);
                        }
                        const finalChunk = mp3Encoder.flush();
                        if (finalChunk.length) mp3Data.push(finalChunk);
                        resolve(new Blob(mp3Data, { type: 'audio/mp3' }));
                    }, reject);
                };
                fileReader.readAsArrayBuffer(webmBlob);
            });
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function processAudioFeatures(mp3Blob) {
            const transcript = await simulateAudioTranscript();
            const fillerWordCount = countFillerWords(transcript);
            const stutterCount = countStutters(transcript);
            return {
                transcript: transcript,
                audioFeatures: { fillerWordCount, stutterCount, rawContent: transcript }
            };
        }

        async function simulateAudioTranscript() {
            const currentLevelData = userAnswerData.levelData[currentLevelIndex];
            const transcriptMap = {
                1: [
                    "å¼€åœºç™½ï¼šæ‚¨å¥½ï¼Œæ¬¢è¿å’¨è¯¢æˆ‘å¸æ ¸å¿ƒäº§å“ã€‚è¯¥äº§å“çš„æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬é«˜æ•ˆæ•°æ®å¤„ç†ã€æ™ºèƒ½åˆ†æé¢„è­¦ã€å¤šç«¯åŒæ­¥åä½œï¼Œç«äº‰ä¼˜åŠ¿ä½“ç°åœ¨æ€§ä»·æ¯”é«˜ã€å”®åå“åº”å¿«ï¼Œæœ€åæ„Ÿè°¢æ‚¨çš„è†å¬ï¼Œè¿™æ˜¯æˆ‘çš„ç»“æŸè¯­ã€‚",
                    "å•Šï¼Œæ‚¨å¥½ï¼Œé‚£ä¸ªæˆ‘å¸æ ¸å¿ƒäº§å“çš„æ ¸å¿ƒåŠŸèƒ½æœ‰ä¸‰ä¸ªï¼Œå‘ƒï¼Œç«äº‰ä¼˜åŠ¿å¥½åƒæ˜¯æ€§ä»·æ¯”é«˜ï¼Œå—¯ï¼Œå°±è¿™æ ·å§ã€‚"
                ],
                2: [
                    "æ‚¨å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œæˆ‘å…ˆåšä¸ªç ´å†°å¼€åœºã€‚æˆ‘æƒ³è¯·æ•™æ‚¨ä¸‰ä¸ªå¼€æ”¾æ€§é—®é¢˜ï¼šæ‚¨ç›®å‰åœ¨ä½¿ç”¨åŒç±»äº§å“å—ï¼Ÿæ‚¨å¯¹äº§å“æœ€å…³æ³¨çš„ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿæ‚¨å¸Œæœ›äº§å“èƒ½è§£å†³æ‚¨çš„ä»€ä¹ˆç—›ç‚¹ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä¼šç¡®è®¤æ‚¨çš„çœŸå®éœ€æ±‚ï¼Œå¹¶è¡¨è¾¾æˆ‘çš„åŒç†å¿ƒã€‚",
                    "é‚£ä¸ªï¼Œä½ æœ‰æ²¡æœ‰ç”¨è¿‡ç±»ä¼¼äº§å“ï¼Ÿå‘ƒï¼Œä½ æƒ³è¦ä»€ä¹ˆåŠŸèƒ½ï¼Ÿå•Šï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“è¯¥é—®å•¥äº†ã€‚"
                ],
                3: [
                    "å®¢æˆ·æ‚¨å¥½ï¼Œæˆ‘éå¸¸ç†è§£æ‚¨è§‰å¾—ä»·æ ¼åé«˜çš„é¡¾è™‘ï¼Œè¿™æ˜¯æˆ‘çš„åŒç†å¿ƒè¡¨è¾¾ã€‚æˆ‘å¯ä»¥ç»™æ‚¨æä¾›å­£åº¦ä»˜è´¹çš„æŠ˜ä¸­è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶æˆ‘ä»¬çš„äº§å“å”®åæœåŠ¡å®Œå–„ï¼Œè¿™æ˜¯å®ƒçš„æ ¸å¿ƒä»·å€¼ï¼Œèƒ½ä¸ºæ‚¨èŠ‚çœé•¿æœŸæˆæœ¬ã€‚",
                    "å“å‘€ï¼Œè¿™ä¸ªä»·æ ¼å·²ç»æœ€ä½äº†ï¼Œä½ ä¸ä¹°å°±æ²¡äº†ï¼Œç»å¯¹åˆ’ç®—ï¼Œæˆ‘æ²¡åŠæ³•ç»™ä½ ä¼˜æƒ äº†ã€‚"
                ]
            };
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(transcriptMap[currentLevelData.levelId][Math.floor(Math.random() * 2)]);
                }, 500);
            });
        }

        function countFillerWords(transcript) {
            if (!transcript) return 0;
            let count = 0;
            fillerWordList.forEach(word => {
                const matches = transcript.match(new RegExp(word, 'g'));
                if (matches) count += matches.length;
            });
            return count;
        }

        function countStutters(transcript) {
            if (!transcript) return 0;
            const matches = transcript.match(/([ï¼Œã€‚ï¼ï¼Ÿ]{2,})|([å‘ƒå•Šå—¯]{2,})/g);
            return matches ? matches.length : 0;
        }

        // åŒæ­¥æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¼€å‘è€…ç«¯å®æ—¶è¯»å–ï¼‰
        function syncAudioData(mp3Url, mp3Base64, processResult) {
            const globalAnswerData = JSON.parse(localStorage.getItem('speakingGameAnswerData')) || {};
            const currentLevelData = userAnswerData.levelData[currentLevelIndex];
            currentLevelData.audioMP3Base64 = mp3Base64;
            currentLevelData.audioUrl = mp3Url;
            currentLevelData.transcript = processResult.transcript;
            currentLevelData.audioFeatures = processResult.audioFeatures;
            userAnswerData.currentLevel = currentLevelIndex;
            globalAnswerData[userUniqueId] = userAnswerData;
            localStorage.setItem('speakingGameAnswerData', JSON.stringify(globalAnswerData));
            window.dispatchEvent(new StorageEvent('storage', { key: 'speakingGameAnswerData' }));
        }

        // å…³å¡åˆ‡æ¢å’Œæäº¤å‡½æ•°
        function goToPrevLevel() {
            if (currentLevelIndex > 0) {
                clearInterval(timerInterval);
                currentLevelIndex--;
                userAnswerData.currentLevel = currentLevelIndex;
                initCurrentLevel(currentLevelIndex);
            }
        }

        function goToNextLevel() {
            if (currentLevelIndex < userAnswerData.levelData.length - 1) {
                clearInterval(timerInterval);
                currentLevelIndex++;
                userAnswerData.currentLevel = currentLevelIndex;
                initCurrentLevel(currentLevelIndex);
            }
        }

        function submitAllAnswers() {
            clearInterval(timerInterval);
            const globalAnswerData = JSON.parse(localStorage.getItem('speakingGameAnswerData')) || {};
            userAnswerData.isCompleted = true;
            userAnswerData.completeTime = new Date().toLocaleString();
            globalAnswerData[userUniqueId] = userAnswerData;
            localStorage.setItem('speakingGameAnswerData', JSON.stringify(globalAnswerData));
            window.dispatchEvent(new StorageEvent('storage', { key: 'speakingGameAnswerData' }));
            answerModule.classList.add('module-hidden');
            completeModule.classList.remove('module-hidden');
            completeUserTip.textContent = `å°Šæ•¬çš„ã€${userUniqueId}ã€‘ï¼Œæ‚¨çš„æ‰€æœ‰å½•éŸ³å·²åŒæ­¥è‡³ç®¡ç†å¹³å°`;
        }

        function goBackToEntry() {
            completeModule.classList.add('module-hidden');
            entryModule.classList.remove('module-hidden');
            userUniqueIdInput.value = '';
            idErrorTip.classList.add('module-hidden');
        }
    </script>
</body>
</html>